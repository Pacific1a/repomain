# üöÄ –ü–õ–ê–ù –°–û–ó–î–ê–ù–ò–Ø –ù–û–í–û–ì–û –ß–ò–°–¢–û–ì–û –°–ï–†–í–ï–†–ê

## üéØ –¶–ï–õ–¨
–°–æ–∑–¥–∞—Ç—å –æ–¥–∏–Ω —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π:
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –±–æ—Ç–æ–º (Telegram Python bot)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –º–∏–Ω–∏–∞–ø–ø–æ–º (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≤ Telegram)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å —Å–∞–π—Ç–æ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ù–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å–∞–º —Å —Å–æ–±–æ–π

---

## üìÅ –ù–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê

```
duo/
‚îú‚îÄ‚îÄ server/                          # –ù–û–í–´–ô –°–ï–†–í–ï–† (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π!)
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.js             # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SQLite
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ constants.js            # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js                 # JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhook.js              # Webhook –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.routes.js          # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–ª–æ–≥–∏–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ partner.routes.js       # API –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bot.routes.js           # API –¥–ª—è Telegram –±–æ—Ç–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ referral.routes.js      # –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.service.js         # –†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral.service.js     # –õ–æ–≥–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ balance.service.js      # –†–∞–±–æ—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.db             # SQLite –±–∞–∑–∞
‚îÇ   ‚îú‚îÄ‚îÄ .env                        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ server.js                   # –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ
‚îÇ
‚îú‚îÄ‚îÄ bot/                             # Python Telegram –±–æ—Ç (–ë–ï–ó —Å–µ—Ä–≤–µ—Ä–æ–≤!)
‚îÇ   ‚îú‚îÄ‚îÄ autoshop/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tgbot/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ routers/            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ data/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ config.py       # SERVER_URL + PARTNER_API_SECRET
‚îÇ   ‚îú‚îÄ‚îÄ index.html                  # –ú–∏–Ω–∏–∞–ø–ø (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥)
‚îÇ   ‚îú‚îÄ‚îÄ referral-system.js          # –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –º–∏–Ω–∏–∞–ø–ø–∞)
‚îÇ
‚îú‚îÄ‚îÄ site/                            # –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π —Å–∞–π—Ç (–¢–û–õ–¨–ö–û —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥!)
‚îÇ   ‚îú‚îÄ‚îÄ index.html                  # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/                  # –î–∞—à–±–æ—Ä–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îî‚îÄ‚îÄ (–¥—Ä—É–≥–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã)
‚îÇ
‚îî‚îÄ‚îÄ deploy/                          # –°–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è
    ‚îú‚îÄ‚îÄ setup.sh                    # –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    ‚îú‚îÄ‚îÄ clean.sh                    # –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    ‚îî‚îÄ‚îÄ update.sh                   # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
```

---

## üîÑ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ù–û–í–û–ì–û –°–ï–†–í–ï–†–ê

### 1. EXPRESS APP (server.js)

```javascript
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const path = require('path');

const app = express();

// Middleware
app.use(helmet());
app.use(cors());
app.use(express.json());

// –°—Ç–∞—Ç–∏–∫–∞
app.use('/bot', express.static(path.join(__dirname, '../bot')));        // –ú–∏–Ω–∏–∞–ø–ø
app.use('/partner', express.static(path.join(__dirname, '../site')));   // –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π —Å–∞–π—Ç
app.use('/uploads', express.static(path.join(__dirname, './uploads'))); // –§–∞–π–ª—ã

// API Routes
app.use('/api/auth', require('./routes/auth.routes'));           // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
app.use('/api/partner', require('./routes/partner.routes'));     // –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π API
app.use('/api/bot', require('./routes/bot.routes'));             // –ë–æ—Ç API
app.use('/api/referral', require('./routes/referral.routes'));   // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

// Health check
app.get('/health', (req, res) => res.json({ status: 'ok' }));

// Start
const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
    console.log(`Server running on port ${PORT}`);
});
```

---

### 2. –ë–ê–ó–ê –î–ê–ù–ù–´–• (config/database.js)

```javascript
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = process.env.DATABASE_PATH || path.join(__dirname, '../data/database.db');

const db = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error('‚ùå Database error:', err);
        process.exit(1);
    }
    console.log('‚úÖ Connected to database');
    initDatabase();
});

function initDatabase() {
    // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–∞—Ä—Ç–Ω–µ—Ä—ã)
    db.run(`CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        email TEXT UNIQUE NOT NULL,
        login TEXT UNIQUE NOT NULL,
        password TEXT NOT NULL,
        telegram TEXT,
        balance REAL DEFAULT 0,
        role TEXT DEFAULT 'user',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        last_login DATETIME
    )`);
    
    // –¢–∞–±–ª–∏—Ü–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    db.run(`CREATE TABLE IF NOT EXISTS referral_stats (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        referral_code TEXT UNIQUE NOT NULL,
        clicks INTEGER DEFAULT 0,
        first_deposits INTEGER DEFAULT 0,
        deposits INTEGER DEFAULT 0,
        total_deposits REAL DEFAULT 0,
        earnings REAL DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id)
    )`);
    
    // –¢–∞–±–ª–∏—Ü–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
    db.run(`CREATE TABLE IF NOT EXISTS referrals (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        partner_id INTEGER NOT NULL,
        referral_user_id TEXT NOT NULL,
        first_deposit_amount REAL DEFAULT 0,
        total_deposits REAL DEFAULT 0,
        total_earnings REAL DEFAULT 0,
        deposits_count INTEGER DEFAULT 0,
        joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (partner_id) REFERENCES users(id)
    )`);
    
    // –¢–∞–±–ª–∏—Ü–∞ —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤)
    db.run(`CREATE TABLE IF NOT EXISTS referral_events (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        partner_id INTEGER NOT NULL,
        referral_user_id TEXT,
        event_type TEXT NOT NULL,
        amount REAL DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (partner_id) REFERENCES users(id)
    )`);
    
    console.log('‚úÖ Database initialized');
}

module.exports = db;
```

---

### 3. –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê (services/referral.service.js)

```javascript
const db = require('../config/database');

class ReferralService {
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–∫–∞ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
    static registerClick(referralCode, userId) {
        return new Promise((resolve, reject) => {
            // –ù–∞—Ö–æ–¥–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø–æ –∫–æ–¥—É
            db.get('SELECT user_id FROM referral_stats WHERE referral_code = ?', 
                [referralCode], 
                (err, stats) => {
                    if (err) return reject(err);
                    if (!stats) return reject(new Error('Partner not found'));
                    
                    const partnerId = stats.user_id;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ
                    db.get('SELECT id FROM referrals WHERE partner_id = ? AND referral_user_id = ?',
                        [partnerId, userId],
                        (err, existing) => {
                            if (err) return reject(err);
                            
                            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º clicks –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                            db.run('UPDATE referral_stats SET clicks = clicks + 1 WHERE user_id = ?',
                                [partnerId],
                                (err) => {
                                    if (err) return reject(err);
                                    
                                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—ã—Ç–∏–µ
                                    db.run('INSERT INTO referral_events (partner_id, referral_user_id, event_type) VALUES (?, ?, ?)',
                                        [partnerId, userId, 'click']);
                                    
                                    if (existing) {
                                        resolve({ success: true, alreadyExists: true, partnerId });
                                    } else {
                                        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
                                        db.run('INSERT INTO referrals (partner_id, referral_user_id) VALUES (?, ?)',
                                            [partnerId, userId],
                                            function(err) {
                                                if (err) return reject(err);
                                                resolve({ success: true, referralId: this.lastID, partnerId });
                                            }
                                        );
                                    }
                                }
                            );
                        }
                    );
                }
            );
        });
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞
    static registerFirstDeposit(referralCode, userId, depositAmount) {
        return new Promise((resolve, reject) => {
            db.get('SELECT user_id FROM referral_stats WHERE referral_code = ?', 
                [referralCode], 
                (err, stats) => {
                    if (err) return reject(err);
                    if (!stats) return reject(new Error('Partner not found'));
                    
                    const partnerId = stats.user_id;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                    db.run(`UPDATE referral_stats 
                            SET first_deposits = first_deposits + 1,
                                deposits = deposits + 1,
                                total_deposits = total_deposits + ?
                            WHERE user_id = ?`,
                        [depositAmount, partnerId],
                        (err) => {
                            if (err) return reject(err);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞
                            db.run(`UPDATE referrals 
                                    SET first_deposit_amount = ?,
                                        total_deposits = total_deposits + ?,
                                        deposits_count = deposits_count + 1
                                    WHERE partner_id = ? AND referral_user_id = ?`,
                                [depositAmount, depositAmount, partnerId, userId],
                                (err) => {
                                    if (err) return reject(err);
                                    
                                    // –°–æ–±—ã—Ç–∏–µ
                                    db.run('INSERT INTO referral_events (partner_id, referral_user_id, event_type, amount) VALUES (?, ?, ?, ?)',
                                        [partnerId, userId, 'first_deposit', depositAmount]);
                                    
                                    resolve({ success: true, partnerId, depositAmount });
                                }
                            );
                        }
                    );
                }
            );
        });
    }
    
    // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—É
    static addEarnings(referralCode, userId, lossAmount) {
        return new Promise((resolve, reject) => {
            const earnings = lossAmount * 0.6;  // 60% –ø–∞—Ä—Ç–Ω–µ—Ä—É
            
            db.get('SELECT user_id FROM referral_stats WHERE referral_code = ?', 
                [referralCode], 
                (err, stats) => {
                    if (err) return reject(err);
                    if (!stats) return reject(new Error('Partner not found'));
                    
                    const partnerId = stats.user_id;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º earnings –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                    db.run('UPDATE referral_stats SET earnings = earnings + ? WHERE user_id = ?',
                        [earnings, partnerId],
                        (err) => {
                            if (err) return reject(err);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º earnings —Ä–µ—Ñ–µ—Ä–∞–ª–∞
                            db.run('UPDATE referrals SET total_earnings = total_earnings + ? WHERE partner_id = ? AND referral_user_id = ?',
                                [earnings, partnerId, userId],
                                (err) => {
                                    if (err) return reject(err);
                                    
                                    // –°–æ–±—ã—Ç–∏–µ
                                    db.run('INSERT INTO referral_events (partner_id, referral_user_id, event_type, amount) VALUES (?, ?, ?, ?)',
                                        [partnerId, userId, 'earning', earnings]);
                                    
                                    resolve({ success: true, earnings, partnerId });
                                }
                            );
                        }
                    );
                }
            );
        });
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞
    static getPartnerStats(partnerId) {
        return new Promise((resolve, reject) => {
            db.get('SELECT * FROM referral_stats WHERE user_id = ?', [partnerId], (err, stats) => {
                if (err) return reject(err);
                if (!stats) return resolve(null);
                
                resolve({
                    referralCode: stats.referral_code,
                    clicks: stats.clicks,
                    firstDeposits: stats.first_deposits,
                    deposits: stats.deposits,
                    totalDeposits: parseFloat(stats.total_deposits).toFixed(2),
                    earnings: parseFloat(stats.earnings).toFixed(2),
                    costPerClick: stats.clicks > 0 ? (stats.earnings / stats.clicks).toFixed(2) : 0,
                    avgIncomePerPlayer: stats.first_deposits > 0 ? (stats.total_deposits / stats.first_deposits).toFixed(2) : 0
                });
            });
        });
    }
}

module.exports = ReferralService;
```

---

### 4. WEBHOOK ROUTES (routes/referral.routes.js)

```javascript
const express = require('express');
const router = express.Router();
const ReferralService = require('../services/referral.service');
const { webhookAuth } = require('../middleware/webhook');
const { jwtAuth } = require('../middleware/auth');

// ============ WEBHOOK ENDPOINTS (–æ—Ç Python –±–æ—Ç–∞) ============

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–∫–∞
router.post('/register', webhookAuth, async (req, res) => {
    try {
        const { userId, referrerId } = req.body;
        
        if (!userId || !referrerId) {
            return res.status(400).json({ success: false, message: 'Missing userId or referrerId' });
        }
        
        const result = await ReferralService.registerClick(referrerId, userId);
        res.json(result);
    } catch (error) {
        console.error('Error registering click:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞
router.post('/register-referral', webhookAuth, async (req, res) => {
    try {
        const { referralCode, referralUserId, depositAmount } = req.body;
        
        if (!referralCode || !referralUserId || !depositAmount) {
            return res.status(400).json({ success: false, message: 'Missing data' });
        }
        
        const result = await ReferralService.registerFirstDeposit(referralCode, referralUserId, depositAmount);
        res.json(result);
    } catch (error) {
        console.error('Error registering first deposit:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞
router.post('/add-earnings', webhookAuth, async (req, res) => {
    try {
        const { referralCode, referralUserId, lossAmount } = req.body;
        
        if (!referralCode || !referralUserId || !lossAmount) {
            return res.status(400).json({ success: false, message: 'Missing data' });
        }
        
        const result = await ReferralService.addEarnings(referralCode, referralUserId, lossAmount);
        res.json(result);
    } catch (error) {
        console.error('Error adding earnings:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// ============ API ENDPOINTS (–æ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞) ============

// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞
router.get('/partner/stats', jwtAuth, async (req, res) => {
    try {
        const stats = await ReferralService.getPartnerStats(req.userId);
        
        if (!stats) {
            return res.status(404).json({ success: false, message: 'No stats found' });
        }
        
        res.json({ success: true, ...stats });
    } catch (error) {
        console.error('Error getting stats:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

module.exports = router;
```

---

## üîê MIDDLEWARE

### Webhook Auth (middleware/webhook.js)
```javascript
const webhookAuth = (req, res, next) => {
    const apiSecret = req.headers['x-api-secret'];
    const expectedSecret = process.env.PARTNER_API_SECRET;
    
    if (!apiSecret || apiSecret !== expectedSecret) {
        console.warn('‚ö†Ô∏è Unauthorized webhook attempt from:', req.ip);
        return res.status(401).json({ success: false, message: 'Unauthorized' });
    }
    
    next();
};

module.exports = { webhookAuth };
```

### JWT Auth (middleware/auth.js)
```javascript
const jwt = require('jsonwebtoken');

const jwtAuth = (req, res, next) => {
    const token = req.headers.authorization?.split(' ')[1];
    
    if (!token) {
        return res.status(401).json({ success: false, message: 'Token missing' });
    }
    
    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        req.userId = decoded.userId;
        next();
    } catch (error) {
        return res.status(401).json({ success: false, message: 'Invalid token' });
    }
};

module.exports = { jwtAuth };
```

---

## üìã PACKAGE.JSON

```json
{
  "name": "duo-server",
  "version": "1.0.0",
  "description": "Unified server for DUO project",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "helmet": "^7.1.0",
    "sqlite3": "^5.1.6",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "express-validator": "^7.0.1",
    "dotenv": "^16.6.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.2"
  }
}
```

---

## üåç –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø (.env)

```bash
# Server
PORT=3000
NODE_ENV=production

# Security
JWT_SECRET=your-super-secret-jwt-key-change-in-production
PARTNER_API_SECRET=e1e6547a80623ab936abfe561a8a0871

# Database
DATABASE_PATH=/var/www/duo/server/data/database.db

# Site URL
SITE_URL=http://77.239.125.70
```

---

## üöÄ NGINX –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

```nginx
server {
    listen 80;
    server_name 77.239.125.70;

    # API
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # –ú–∏–Ω–∏–∞–ø–ø
    location /bot/ {
        proxy_pass http://localhost:3000/bot/;
    }

    # –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π —Å–∞–π—Ç
    location / {
        proxy_pass http://localhost:3000/partner/;
    }
}
```

---

## üì¶ PM2 –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'duo-server',
      script: 'server/server.js',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'production'
      }
    },
    {
      name: 'duo-bot',
      script: 'bot/autoshop/main.py',
      interpreter: 'bot/autoshop/venv/bin/python',
      instances: 1,
      autorestart: true,
      watch: false
    }
  ]
};
```

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
2. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å `server/server.js`
3. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ —Ä–æ—É—Ç—ã –∏ —Å–µ—Ä–≤–∏—Å—ã
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Python –±–æ—Ç (–æ–±–Ω–æ–≤–∏—Ç—å SERVER_URL)
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è
6. ‚úÖ –û—á–∏—Å—Ç–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
7. ‚úÖ –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
8. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é —Ü–µ–ø–æ—á–∫—É

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!** üöÄ

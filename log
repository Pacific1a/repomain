root@duos:/var/www/duo# git pull origin main
From https://github.com/Pacific1a/repomain
 * branch            main       -> FETCH_HEAD
Already up to date.
root@duos:/var/www/duo# cd /var/www/duo/server
root@duos:/var/www/duo/server#      node migrate-add-total-losses.js
� Migration: Adding total_losses column to referral_stats
� Database: /var/www/duo/server/data/database.db
✅ Connected to database
ℹ️  Column total_losses already exists

� referral_stats columns:
  - id (INTEGER)
  - user_id (INTEGER)
  - referral_code (TEXT)
  - clicks (INTEGER)
  - first_deposits (INTEGER)
  - deposits (INTEGER)
  - total_deposits (REAL)
  - earnings (REAL)
  - created_at (DATETIME)
  - total_losses (REAL)

✅ Migration complete!
root@duos:/var/www/duo/server#  pm2 restart duo-server
Use --update-env to update environment variables
[PM2] Applying action restartProcessId on app [duo-server](ids: [ 0 ])
[PM2] [duo-server](0) ✓
┌────┬───────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name          │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
├────┼───────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
│ 1  │ duo-bot       │ default     │ N/A     │ fork    │ 679746   │ 2D     │ 224… │ online    │ 0%       │ 152.8mb  │ root     │ disabled │
│ 0  │ duo-server    │ default     │ 2.0.0   │ fork    │ 724907   │ 0s     │ 110  │ online    │ 0%       │ 15.8mb   │ root     │ disabled │
└────┴───────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
root@duos:/var/www/duo/server# pm2 logs duo-server
[TAILING] Tailing last 15 lines for [duo-server] process (change the value with --lines option)
/root/.pm2/logs/duo-server-error.log last 15 lines:
0|duo-serv | ❌ BlackJack: No telegramId in socket handshake
0|duo-serv | ❌ Mines: No telegramId in socket handshake
0|duo-serv | ❌ BlackJack: No telegramId in socket handshake
0|duo-serv | ❌ Mines: No telegramId in socket handshake
0|duo-serv | ❌ BlackJack: No telegramId in socket handshake
0|duo-serv | ❌ Mines: No telegramId in socket handshake
0|duo-serv | ❌ BlackJack: No telegramId in socket handshake
0|duo-serv | ❌ Mines: No telegramId in socket handshake
0|duo-serv | ❌ BlackJack: No telegramId in socket handshake
0|duo-serv | ❌ Mines: No telegramId in socket handshake
0|duo-serv | ❌ BlackJack: No telegramId in socket handshake
0|duo-serv | ❌ Mines: No telegramId in socket handshake
0|duo-serv | ❌ BlackJack: No telegramId in socket handshake
0|duo-serv | ❌ Mines: No telegramId in socket handshake
0|duo-serv | ❌ BlackJack: No telegramId in socket handshake

/root/.pm2/logs/duo-server-out.log last 15 lines:
0|duo-serv | � Mines: Player 1889923046 connected
0|duo-serv | � BlackJack: Player 1889923046 connected
0|duo-serv | � Socket.IO client connected: -74uAq2ORCqiDGE4AAAH
0|duo-serv | � Socket.IO client connected: fCwW_XNMrQ4up-sUAAAJ
0|duo-serv | � Mines: Player 1889923046 connected
0|duo-serv | � BlackJack: Player 1889923046 connected
0|duo-serv | ✅ JWT Auth: userId=4
0|duo-serv | � /api/referral/partner/stats: userId=4
0|duo-serv | ✅ JWT Auth: userId=4
0|duo-serv | � /api/referral/partner/stats/timeline: userId=4, period=week
0|duo-serv | ✅ JWT Auth: userId=4
0|duo-serv | ✅ JWT Auth: userId=4
0|duo-serv | � /api/auth/user: userId=4
0|duo-serv | ✅ JWT Auth: userId=4
0|duo-serv | � /api/referral/partner/stats: userId=4

0|duo-server  | � GET /api/balance/1889923046
0|duo-server  | � Баланс загружен из Bot DB: 1889923046 → 25500₽
0|duo-server  | � BlackJack: 1889923046 disconnected
0|duo-server  | ❌ Socket.IO client disconnected: Ib8ucAAPZk0WKGrbAAAB
0|duo-server  | ❌ Socket.IO client disconnected: cEPCGIy5nAzRqKo5AAAD
0|duo-server  | � GET /api/balance/1889923046
0|duo-server  | � /api/referral/1889923046: GET referral data
0|duo-server  | � Socket.IO client connected: K5eUpwFIGEYIa7-jAAAL
0|duo-server  | � Mines: Player 1889923046 connected
0|duo-server  | � BlackJack: Player 1889923046 connected
0|duo-server  | � Player joined Crash
0|duo-server  | � Socket.IO client connected: zgASKQRXuFfc3LMNAAAN
0|duo-server  | ❌ Mines: No telegramId in socket handshake
0|duo-server  | ❌ BlackJack: No telegramId in socket handshake
0|duo-server  | ⏳ Crash: Ожидание 5 сек...
0|duo-server  | � Crash started! Will crash at: 1.36x
0|duo-server  | � POST /api/balance/1889923046/subtract: {
0|duo-server  |   subtractAmount: 500,
0|duo-server  |   subtractChips: 0,
0|duo-server  |   gameType: 'unknown',
0|duo-server  |   reason: 'game'
0|duo-server  | }
0|duo-server  | ✅ Balance subtracted: 1889923046 -500₽ -0 chips
0|duo-server  | � POST /api/transactions/1889923046: { type: 'subtract', amount: 500, source: 'game' }
0|duo-server  | ✅ Transaction added: 1889923046 subtract 500
0|duo-server  | � /api/referral/add-earnings: referralUser=1889923046, loss=500₽
0|duo-server  | � Add earnings: referralUser=1889923046, loss=500
0|duo-server  | � Finding partner for referral user: 1889923046
0|duo-server  | ✅ Found partner: 3 for referral: 1889923046
0|duo-server  | � Partner 3 will earn 300₽ (60% of 500₽ loss)
0|duo-server  | ✅ Earnings added: partner=3, earnings=300₽ (60% of 500₽)
0|duo-server  | ⚠️ Нельзя ставить во время игры (статус: flying)
0|duo-server  | � Crash ended at: 1.36x
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | � /api/referral/partner/stats/timeline: userId=4, period=week
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | � /api/referral/partner/stats: userId=4
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | � /api/auth/user: userId=4
0|duo-server  | ⏳ Crash: Ожидание 5 сек...
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | � /api/referral/partner/stats: userId=4
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | � /api/referral/partner/stats: userId=4
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | � /api/referral/partner/stats/timeline: userId=4, period=week
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | � /api/auth/user: userId=4
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | ✅ JWT Auth: userId=4
0|duo-server  | � /api/referral/partner/stats: userId=4
0|duo-server  | � Crash started! Will crash at: 1.46x
0|duo-server  | � Crash ended at: 1.46x

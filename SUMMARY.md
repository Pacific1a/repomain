# 📋 ИТОГОВАЯ СВОДКА - Реферальная интеграция БОТ ↔ САЙТ

## ✅ ЧТО СДЕЛАНО

### 1. **Созданы модули для БОТА:**

- **`bot/server/partner-webhook.js`**  
  HTTP клиент для отправки данных на сайт
  
- **`bot/server/referral-tracker.js`**  
  Отслеживание событий: переходы, депозиты, проигрыши

### 2. **Документация:**

- **`INTEGRATION_GUIDE.md`** - полное руководство по интеграции
- **`INTEGRATION_PATCHES.md`** - конкретные патчи для кода
- **`.env.example`** - примеры конфигурации для бота и сайта

---

## 🎯 КАК ЭТО РАБОТАЕТ

```
ПАРТНЕР                   БОТ                        САЙТ
   │                       │                           │
   │ 1. Создает реф.       │                           │
   │    ссылку на сайте    │                           │
   │───────────────────────┼──────────────────────────>│
   │                       │                           │
   │                       │ 2. Пользователь переходит │
   │                       │    по ссылке ref_XXX      │
   │                       │<──────────────────────────│
   │                       │                           │
   │                       │ 3. Бот отправляет webhook:│
   │                       │    POST /api/referral/    │
   │                       │         click             │
   │                       │──────────────────────────>│
   │                       │                           │
   │                       │ 4. Пользователь пополняет │
   │                       │    баланс                 │
   │                       │                           │
   │                       │ 5. Бот отправляет:        │
   │                       │    POST /api/referral/    │
   │                       │         register-referral │
   │                       │──────────────────────────>│
   │                       │                           │
   │                       │ 6. Пользователь играет    │
   │                       │    и проигрывает 1000₽    │
   │                       │                           │
   │                       │ 7. Бот отправляет:        │
   │                       │    POST /api/referral/    │
   │                       │         add-earnings      │
   │                       │    (партнер получает 10%) │
   │                       │──────────────────────────>│
   │                       │                           │
   │ 8. Видит статистику:  │                           │
   │    - Переходов: 1     │                           │
   │    - Депозитов: 1     │                           │
   │    - Доход: 100₽      │                           │
   │<──────────────────────┼───────────────────────────│
```

---

## 🚀 ЧТО НУЖНО СДЕЛАТЬ

### ШАГ 1: Добавить модули в БОТ

```bash
# Файлы уже созданы:
bot/server/partner-webhook.js  ✅
bot/server/referral-tracker.js ✅
```

### ШАГ 2: Применить патчи

**Используй файл `INTEGRATION_PATCHES.md`**

1. ✅ Добавить require в `bot/server/server.js`
2. ✅ Обработка start_param в `socket.on('auth')`
3. ✅ Отслеживание депозитов в `/api/balance`
4. ✅ Отслеживание проигрышей в играх
5. ✅ Добавить middleware на сайте

### ШАГ 3: Настроить .env

**БОТ (`bot/server/.env`):**
```env
PARTNER_SITE_URL=https://duo-site.onrender.com
PARTNER_API_SECRET=your-secret-key
```

**САЙТ (`site/server/.env`):**
```env
PARTNER_API_SECRET=your-secret-key  # ТАКОЙ ЖЕ!
```

### ШАГ 4: Деплой на Render

**Два отдельных сервиса:**
- `duo-bot` → bot/server/server.js
- `duo-site` → site/server/server.js

**Environment Variables на обоих:**
```
PARTNER_API_SECRET = same-secret-for-both
```

---

## 📊 API ENDPOINTS

### НА САЙТЕ (уже есть):

```
POST /api/referral/click               - Регистрация клика
POST /api/referral/register-referral   - Первый депозит
POST /api/referral/add-earnings        - Начисление дохода
POST /api/referral/update-deposit      - Повторное пополнение
```

### В БОТЕ (добавить вызовы):

```javascript
// При старте с реферальной ссылкой:
await tracker.handleStart(userId, startParam);

// При пополнении:
await tracker.handleDeposit(userId, amount);

// При проигрыше:
await tracker.handleLoss(userId, lossAmount, 'crash');
```

---

## 🔒 БЕЗОПАСНОСТЬ

### API ключ защищает webhook'и:

```javascript
// БОТ отправляет:
headers: {
  'X-API-Secret': process.env.PARTNER_API_SECRET
}

// САЙТ проверяет:
if (req.headers['x-api-secret'] !== process.env.PARTNER_API_SECRET) {
  return 401 Unauthorized
}
```

---

## 🧪 ТЕСТИРОВАНИЕ

### Локально:

1. Запусти БОТ на порту 3000
2. Запусти САЙТ на порту 3001
3. В боте укажи: `PARTNER_SITE_URL=http://localhost:3001`

### На Render:

1. Деплой БОТ → получи URL: `https://duo-bot.onrender.com`
2. Деплой САЙТ → получи URL: `https://duo-site.onrender.com`
3. В боте укажи: `PARTNER_SITE_URL=https://duo-site.onrender.com`

---

## 📈 РЕЗУЛЬТАТ

### ДО интеграции:
❌ Бот и сайт не общаются  
❌ Партнеры не видят статистику  
❌ Данные не синхронизируются  

### ПОСЛЕ интеграции:
✅ Бот отправляет данные на сайт через HTTP  
✅ Партнеры видят клики, депозиты, доход  
✅ Реферальная система работает между двумя сервисами  
✅ Каждый сервис на своем хосте (не объединены!)  

---

## 💡 УПРОЩЕННАЯ СХЕМА

```
1. Пользователь переходит по ссылке → БОТ знает от какого партнера
2. Пользователь пополняет → БОТ уведомляет САЙТ
3. Пользователь проигрывает → БОТ начисляет % партнеру через САЙТ
4. Партнер видит статистику на САЙТЕ
```

---

## 📞 ЧТО ДАЛЬШЕ?

1. **Применить патчи** из `INTEGRATION_PATCHES.md`
2. **Настроить .env** на обоих сервисах
3. **Протестировать** локально
4. **Задеплоить** на Render
5. **Profit!** 🎉

---

## ❓ ЕСЛИ ЧТО-ТО НЕ РАБОТАЕТ

Читай `INTEGRATION_GUIDE.md` → раздел "Диагностика проблем"

Основные проблемы:
- API ключи не совпадают → проверь .env
- Webhook не отправляется → проверь PARTNER_SITE_URL
- 401 ошибка → перезапусти сервисы после изменения .env

---

**Вся система БЕЗ ОБЪЕДИНЕНИЯ серверов!**  
**Два независимых сервиса общаются по HTTP!** 🚀

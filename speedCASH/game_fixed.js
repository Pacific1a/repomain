class SpeedCashGame {
    constructor() {
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
        console.log(`üì± –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${this.isMobile}`);
        
        this.gameState = 'waiting'; // 'waiting', 'betting', 'racing', 'finished'
        this.blueBet = 50;
        this.orangeBet = 50;
        this.currentBlueBet = null;
        this.currentOrangeBet = null;
        
        // Single mode
        this.singleBet = 50;
        this.currentSingleBet = null;
        this.singleSelectedCar = 'blue'; // 'blue' –∏–ª–∏ 'orange'
        
        this.blueMultiplier = 1.00;
        this.orangeMultiplier = 1.00;
        this.raceStartTime = null;
        this.raceDuration = 20000; // 20 seconds race
        this.animationId = null;
        this.roadAnimationId = null;
        this.winner = null;
        this.balance = 1000; // Starting balance (displayed in HTML)
        this.bettingTimer = null;
        this.bettingTimeLeft = 5; // 5 seconds to bet
        this.delayedCar = null; // Only one car gets delayed
        this.blueStopMultiplier = 2 + Math.random() * 6; // Random stop point 2-8x
        this.orangeStopMultiplier = 2 + Math.random() * 6; // Random stop point 2-8x
        this.bluePosition = 0;
        this.orangePosition = 0;
        this.gameEnded = false;
        this.blueEscaped = false;
        this.orangeEscaped = false;
        this.escapeTextShown = false;
        this.racingPhase = false;
        
        // Auto Cash Out
        this.blueAutoCashOutEnabled = false;
        this.orangeAutoCashOutEnabled = false;
        this.blueAutoCashOutMultiplier = 2.00;
        this.orangeAutoCashOutMultiplier = 2.00;
        
        this.initializeElements();
        this.createRoadLines();
        this.showGlassLoader();
        this.initializeWebSocket();
        // Balance update removed - using static HTML value
        // startBettingPhase –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    }

    initializeWebSocket() {
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (typeof io !== 'undefined') {
            this.socket = io();
            console.log('üîå WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
            
            // –¢–∞–π–º–∞—É—Ç 3 —Å–µ–∫—É–Ω–¥—ã - –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –∑–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            const timeout = setTimeout(() => {
                console.log('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª - –∑–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ');
                this.hideGlassLoader();
                this.startBettingPhase();
            }, 3000);
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∏–≥—Ä–µ
            this.socket.emit('join_speedcash');
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            this.socket.emit('get_speedcash_state');
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            this.socket.on('speedcash_current_state', (data) => {
                clearTimeout(timeout); // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–∞—É—Ç
                console.log('üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', data);
                this.syncWithServer(data);
            });
            
            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
            this.socket.on('speedcash_player_bet', (data) => {
                console.log('üéÆ –°—Ç–∞–≤–∫–∞ –∏–≥—Ä–æ–∫–∞:', data);
                // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞–≤–∫–µ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            });
            
            this.socket.on('speedcash_player_cashout', (data) => {
                console.log('üí∞ –ò–≥—Ä–æ–∫ —Å–¥–µ–ª–∞–ª Cash Out:', data);
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            this.socket.on('speedcash_multiplier_update', (data) => {
                this.blueMultiplier = data.blueMultiplier;
                this.orangeMultiplier = data.orangeMultiplier;
                this.updateMultiplierDisplays();
            });
            
            // –ö–æ–Ω–µ—Ü –≥–æ–Ω–∫–∏
            this.socket.on('speedcash_race_end', (data) => {
                console.log('üèÅ –ì–æ–Ω–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å:', data);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.finalBlueMultiplier = data.blueMultiplier;
                this.finalOrangeMultiplier = data.orangeMultiplier;
                
                // –°–†–ê–ó–£ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –∑–∞–¥–µ—Ä–∂–∞–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫–∏
                if (!data.blueEscaped) {
                    this.blueDetained = true;
                    this.showCrashIcon('blue', this.bluePosition);
                }
                if (!data.orangeEscaped) {
                    this.orangeDetained = true;
                    this.showCrashIcon('orange', this.orangePosition);
                }
                
                // –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —É–µ–∑–∂–∞–µ—Ç –ß–ï–†–ï–ó 2 —Å–µ–∫—É–Ω–¥—ã (–Ω–∞–±–∏—Ä–∞–µ—Ç –µ—â–µ –∫–æ—ç—Ñ—Ñ)
                setTimeout(() => {
                    this.blueEscaped = data.blueEscaped;
                    this.orangeEscaped = data.orangeEscaped;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç "–£–ï–•–ê–õ" –ö–û–ì–î–ê –º–∞—à–∏–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç —É–µ–∑–∂–∞—Ç—å
                    if (!this.escapeTextShown) {
                        this.escapeTextShown = true;
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ç–æ —É–µ—Ö–∞–ª
                        if (data.blueEscaped && data.orangeEscaped) {
                            // –û–±–µ —É–µ—Ö–∞–ª–∏ (winner: 'both')
                            this.showEscapeText('blue'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥–ø–∏—Å—å
                        } else if (data.blueEscaped) {
                            this.showEscapeText('blue');
                        } else if (data.orangeEscaped) {
                            this.showEscapeText('orange');
                        } else {
                            // –ù–∏–∫—Ç–æ –Ω–µ —É–µ—Ö–∞–ª (–æ–±–µ –∑–∞–¥–µ—Ä–∂–∞–Ω—ã)
                            this.showBothDetainedScreen();
                        }
                    }
                }, 2000);
            });
            
            // –ù–∞—á–∞–ª–æ —Ñ–∞–∑—ã —Å—Ç–∞–≤–æ–∫
            this.socket.on('speedcash_betting_start', (data) => {
                console.log('üéÆ –ù–∞—á–∞–ª–æ —Ñ–∞–∑—ã —Å—Ç–∞–≤–æ–∫:', data);
                this.gameState = 'betting';
                this.bettingTimeLeft = data.bettingTime || 5;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª–∏
                this.blueMultiplier = 1.00;
                this.orangeMultiplier = 1.00;
                this.delayedCar = data.delayedCar;
                this.updateMultiplierDisplays();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                this.gameEnded = false;
                this.blueEscaped = false;
                this.orangeEscaped = false;
                this.blueDetained = false;
                this.orangeDetained = false;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –º–∞—à–∏–Ω
                this.bluePosition = 0;
                this.orangePosition = 0;
                if (this.blueCar) {
                    this.blueCar.style.transform = 'translateY(0px)';
                }
                if (this.orangeCar) {
                    this.orangeCar.style.transform = 'translateY(0px)';
                }
                
                // –£–¥–∞–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –∑–∞–¥–µ—Ä–∂–∞–Ω–∏—è
                const crashIcons = document.querySelectorAll('.crash-icon');
                crashIcons.forEach(icon => icon.remove());
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                this.processQueuedBets();
                
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä
                if (this.bettingTimer) {
                    clearTimeout(this.bettingTimer);
                }
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ countdown mode
                const raceArea = document.querySelector('.race');
                if (raceArea) {
                    raceArea.classList.add('countdown-mode');
                    raceArea.classList.remove('game-active');
                }
                
                const roadLines = document.getElementById('roadLines');
                if (roadLines) {
                    roadLines.classList.remove('visible');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º countdown
                this.showCountdown();
                const countdownText = document.querySelector('.countdown-text');
                if (countdownText) {
                    countdownText.textContent = this.bettingTimeLeft;
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
            this.socket.on('speedcash_betting_timer', (data) => {
                this.bettingTimeLeft = data.timeLeft;
                const countdownText = document.querySelector('.countdown-text');
                if (countdownText) {
                    countdownText.textContent = this.bettingTimeLeft;
                }
            });
            
            // –ù–∞—á–∞–ª–æ –≥–æ–Ω–∫–∏
            this.socket.on('speedcash_race_start', (data) => {
                console.log('üèÅ –ù–∞—á–∞–ª–æ –≥–æ–Ω–∫–∏:', data);
                this.gameState = 'racing';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª–∏
                this.blueMultiplier = 1.00;
                this.orangeMultiplier = 1.00;
                this.delayedCar = data.delayedCar;
                this.updateMultiplierDisplays();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                this.gameEnded = false;
                this.blueEscaped = false;
                this.orangeEscaped = false;
                this.blueDetained = false;
                this.orangeDetained = false;
                this.escapeTextShown = false;
                
                // –°–∫—Ä—ã–≤–∞–µ–º countdown
                this.hideCountdown();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
                const raceArea = document.querySelector('.race');
                if (raceArea) {
                    raceArea.classList.remove('countdown-mode');
                    raceArea.classList.add('game-active');
                }
                
                const roadLines = document.getElementById('roadLines');
                if (roadLines) {
                    roadLines.classList.add('visible');
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                this.startTime = Date.now();
                this.racePhaseEndTime = this.startTime + 8000;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                if (this.roadAnimationId) {
                    cancelAnimationFrame(this.roadAnimationId);
                    this.roadAnimationId = null;
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                this.animateRace();
                this.animateRoadLines();
            });
        } else {
            console.log('‚ö†Ô∏è WebSocket –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω - –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º');
            this.socket = null;
            // –í –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É
            this.hideGlassLoader();
            this.startBettingPhase();
        }
    }
    
    syncWithServer(data) {
        this.hideGlassLoader();
        
        if (data.status === 'betting' || data.status === 'waiting') {
            // –§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫
            this.gameState = 'betting';
            this.bettingTimeLeft = data.timeLeft || 5;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª–∏
            this.blueMultiplier = 1.00;
            this.orangeMultiplier = 1.00;
            this.updateMultiplierDisplays();
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä
            if (this.bettingTimer) {
                clearTimeout(this.bettingTimer);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º countdown
            this.showCountdown();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º countdown —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º
            const countdownText = document.querySelector('.countdown-text');
            if (countdownText) {
                countdownText.textContent = this.bettingTimeLeft;
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
            const countdown = () => {
                if (this.bettingTimeLeft > 0) {
                    this.bettingTimeLeft--;
                    this.updateCountdown();
                    this.bettingTimer = setTimeout(countdown, 1000);
                } else {
                    this.hideCountdown();
                    this.startRace();
                }
            };
            countdown();
        } else if (data.status === 'racing' || data.status === 'playing') {
            // –ì–æ–Ω–∫–∞ –∏–¥–µ—Ç
            this.gameState = 'racing';
            this.blueMultiplier = data.blueMultiplier || 1.00;
            this.orangeMultiplier = data.orangeMultiplier || 1.00;
            this.updateMultiplierDisplays();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞ - Cash Out enabled, –µ—Å–ª–∏ –Ω–µ—Ç - Bet disabled
            if (this.currentBlueBet) {
                this.updateBetButton('blue', 'cashout', this.currentBlueBet, false);
            } else {
                this.updateBetButton('blue', 'bet', this.blueBet, true);
            }
            if (this.currentOrangeBet) {
                this.updateBetButton('orange', 'cashout', this.currentOrangeBet, false);
            } else {
                this.updateBetButton('orange', 'bet', this.orangeBet, true);
            }
            if (this.currentSingleBet) {
                this.updateSingleButton('cashout', this.currentSingleBet, false);
            } else {
                this.updateSingleButton('bet', this.singleBet, true);
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º countdown, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
            this.hideCountdown();
            const raceArea = document.querySelector('.race');
            if (raceArea) {
                raceArea.classList.remove('countdown-mode');
                raceArea.classList.add('game-active');
            }
            
            const roadLines = document.getElementById('roadLines');
            if (roadLines) {
                roadLines.classList.add('visible');
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            if (!this.animationId) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                if (this.roadAnimationId) {
                    cancelAnimationFrame(this.roadAnimationId);
                    this.roadAnimationId = null;
                }
                
                this.startTime = Date.now() - (data.elapsed || 0);
                this.racePhaseEndTime = this.startTime + 8000;
                this.animateRace();
                this.animateRoadLines();
            }
        }
    }
    
    showGlassLoader() {
        const gameElement = document.querySelector('.game');
        if (!gameElement) return;
        
        const loader = document.createElement('div');
        loader.className = 'glass-loader';
        loader.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 20px;
        `;
        
        const spinner = document.createElement('div');
        spinner.style.cssText = `
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é
        if (!document.getElementById('spinnerAnimation')) {
            const style = document.createElement('style');
            style.id = 'spinnerAnimation';
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
        
        loader.appendChild(spinner);
        gameElement.appendChild(loader);
        this.glassLoader = loader;
    }
    
    hideGlassLoader() {
        if (this.glassLoader && this.glassLoader.parentNode) {
            this.glassLoader.parentNode.removeChild(this.glassLoader);
            this.glassLoader = null;
        }
    }

    initializeElements() {
        // Cache all DOM elements for better performance
        this.blueBetButton = document.querySelector('.div-4:first-child .bet-button');
        this.orangeBetButton = document.querySelector('.div-4:last-child .cash-out-button');
        this.blueBetAmount = document.querySelector('.div-4:first-child .text-wrapper-13');
        this.orangeBetAmount = document.querySelector('.div-4:last-child .text-wrapper-13');
        this.blueMultiplierDisplay = document.querySelector('.text-wrapper-4');
        this.orangeMultiplierDisplay = document.querySelector('.text-wrapper-5');
        this.blueCar = document.querySelector('.auto-blue-2');
        this.orangeCar = document.querySelector('.auto-orange');
        this.raceArea = document.querySelector('.race');
        this.roadLinesContainer = document.getElementById('roadLines');
        this.countdownText = document.querySelector('.countdown-text');
        this.gameElement = document.querySelector('.game');
        
        // Enable GPU acceleration for cars
        if (this.blueCar) {
            this.blueCar.style.transform = 'translateZ(0)';
            this.blueCar.style.willChange = 'transform';
        }
        if (this.orangeCar) {
            this.orangeCar.style.transform = 'translateZ(0)';
            this.orangeCar.style.willChange = 'transform';
        }
        
        // Throttle settings —Ç–æ–ª—å–∫–æ –¥–ª—è DOM –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–Ω–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π)
        this.lastMultiplierUpdate = 0;
        this.multiplierUpdateInterval = this.isMobile ? 70 : 50; // –ú–æ–±–∏–ª—å–Ω—ã–µ: 70ms, –î–µ—Å–∫—Ç–æ–ø: 50ms
        
        this.setupEventListeners();
    }

    setupEventListeners() {
        if (this.blueBetButton) {
            this.blueBetButton.addEventListener('click', () => this.placeBet('blue'));
        }
        if (this.orangeBetButton) {
            this.orangeBetButton.addEventListener('click', () => this.placeBet('orange'));
        }
        
        // Single mode button
        const singleButton = document.querySelector('.who-is-win .bet-button');
        if (singleButton) {
            singleButton.addEventListener('click', () => this.placeBet('single'));
        }
        
        // Setup bet control buttons
        this.setupBetButtons();
    }
    
    setupBetButtons() {
        // Blue buttons
        const blueMinus = document.querySelector('.blue-minus-10');
        const bluePlus = document.querySelector('.blue-plus-10');
        const blueHalf = document.querySelector('.blue-half');
        const blueDouble = document.querySelector('.blue-double');
        
        if (blueMinus) blueMinus.addEventListener('click', () => this.adjustBetAmount('blue', -10));
        if (bluePlus) bluePlus.addEventListener('click', () => this.adjustBetAmount('blue', 10));
        if (blueHalf) blueHalf.addEventListener('click', () => this.adjustBetAmount('blue', 'half'));
        if (blueDouble) blueDouble.addEventListener('click', () => this.adjustBetAmount('blue', 'double'));
        
        // Orange buttons
        const orangeMinus = document.querySelector('.orange-minus-10');
        const orangePlus = document.querySelector('.orange-plus-10');
        const orangeHalf = document.querySelector('.orange-half');
        const orangeDouble = document.querySelector('.orange-double');
        
        if (orangeMinus) orangeMinus.addEventListener('click', () => this.adjustBetAmount('orange', -10));
        if (orangePlus) orangePlus.addEventListener('click', () => this.adjustBetAmount('orange', 10));
        if (orangeHalf) orangeHalf.addEventListener('click', () => this.adjustBetAmount('orange', 'half'));
        if (orangeDouble) orangeDouble.addEventListener('click', () => this.adjustBetAmount('orange', 'double'));
        
        // Single buttons
        const singleMinus = document.querySelector('.single-minus-10');
        const singlePlus = document.querySelector('.single-plus-10');
        const singleHalf = document.querySelector('.single-half');
        const singleDouble = document.querySelector('.single-double');
        const singleSelectBlue = document.querySelector('.single-select-blue');
        const singleSelectOrange = document.querySelector('.single-select-orange');
        
        if (singleMinus) singleMinus.addEventListener('click', () => this.adjustBetAmount('single', -10));
        if (singlePlus) singlePlus.addEventListener('click', () => this.adjustBetAmount('single', 10));
        if (singleHalf) singleHalf.addEventListener('click', () => this.adjustBetAmount('single', 'half'));
        if (singleDouble) singleDouble.addEventListener('click', () => this.adjustBetAmount('single', 'double'));
        if (singleSelectBlue) singleSelectBlue.addEventListener('click', () => this.selectSingleCar('blue'));
        if (singleSelectOrange) singleSelectOrange.addEventListener('click', () => this.selectSingleCar('orange'));
    }

    createRoadLines() {
        const roadContainer = document.getElementById('roadLines');
        if (!roadContainer) return;
        
        // Clear existing lines
        roadContainer.innerHTML = '';
        
        // Create proper dashed road markings with unique IDs
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤: —É–º–µ–Ω—å—à–µ–Ω–æ —Å 15 –¥–æ 12 –ª–∏–Ω–∏–π
        for (let i = 0; i < 12; i++) {
            const line = document.createElement('div');
            line.className = 'road-line';
            line.id = `road-line-${i}`;
            line.style.top = `${i * 80 - 400}px`; // –ë–æ–ª—å—à–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏
            roadContainer.appendChild(line);
        }
    }
    
    animateRoadLines() {
        if (!this.roadLinesContainer) return;
        
        // Cache road lines once
        if (!this.cachedRoadLines) {
            this.cachedRoadLines = Array.from(this.roadLinesContainer.querySelectorAll('.road-line'));
            // Enable GPU acceleration for road lines
            this.cachedRoadLines.forEach(line => {
                line.style.willChange = 'transform';
            });
        }
        
        const animateLines = () => {
            if (this.gameState !== 'racing') return;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–æ—Ä–æ–≥–∏ –Ω–∞ –ø–æ–ª–Ω–æ–º FPS (–±–µ–∑ throttling)
            this.cachedRoadLines.forEach(line => {
                let currentTop = parseFloat(line.dataset.top) || parseInt(line.style.top) || 0;
                currentTop += 3;
                
                if (currentTop > 700) {
                    currentTop = -400;
                }
                
                line.dataset.top = currentTop;
                line.style.transform = `translate3d(0, ${currentTop}px, 0)`;
                line.style.top = '0'; // Reset top to use transform
            });
            
            this.roadAnimationId = requestAnimationFrame(animateLines);
        };
        
        animateLines();
    }

    startBettingPhase() {
        this.gameState = 'betting';
        this.bettingTimeLeft = 5;
        
        // Use cached elements
        if (this.raceArea) {
            this.raceArea.classList.add('countdown-mode');
            this.raceArea.classList.remove('game-active');
        }
        
        if (this.roadLinesContainer) {
            this.roadLinesContainer.classList.remove('visible');
        }
        
        // Show countdown
        this.showCountdown();
        const countdown = () => {
            if (this.bettingTimeLeft > 0) {
                this.bettingTimeLeft--;
                this.updateCountdown();
                this.bettingTimer = setTimeout(countdown, 1000);
            } else {
                this.hideCountdown();
                this.startRace();
            }
        };
        
        countdown();
    }



    showNotification(message) {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            left: 50%;
            top: 10px;
            transform: translateX(-50%);
            background: rgba(60, 60, 60, 0.92);
            color: rgb(229, 229, 229);
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: rgba(0, 0, 0, 0.35) 0px 6px 20px;
            font-family: Montserrat, Inter, Arial, sans-serif;
            font-size: 13px;
            letter-spacing: 0.2px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.2s;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
        setTimeout(() => notification.style.opacity = '1', 10);
        
        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 200);
        }, 3000);
    }

    placeBet(color) {
        // Single mode
        if (color === 'single') {
            return this.placeSingleBet();
        }
        
        const button = this.getButton(color);
        const currentBet = color === 'blue' ? this.currentBlueBet : this.currentOrangeBet;
        
        // –í–æ –≤—Ä–µ–º—è betting —Ñ–∞–∑—ã
        if (this.gameState === 'betting') {
            if (currentBet) {
                // –£–∂–µ –µ—Å—Ç—å —Å—Ç–∞–≤–∫–∞ - –æ—Ç–º–µ–Ω—è–µ–º (Cancel)
                this.cancelBet(color);
            } else {
                // –°—Ç–∞–≤–∏–º –Ω–æ–≤—É—é —Å—Ç–∞–≤–∫—É
                const betAmount = color === 'blue' ? this.blueBet : this.orangeBet;
                if (!window.GameBalanceAPI || !window.GameBalanceAPI.canPlaceBet(betAmount, 'chips')) {
                    this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                    return;
                }
                const success = window.GameBalanceAPI.placeBet(betAmount, 'chips');
                if (success) {
                    if (color === 'blue') {
                        this.currentBlueBet = betAmount;
                    } else {
                        this.currentOrangeBet = betAmount;
                    }
                    this.updateBetButton(color, 'cancel', betAmount);
                    console.log(`‚úÖ –°—Ç–∞–≤–∫–∞ ${betAmount} —á–∏–ø–æ–≤ –Ω–∞ ${color} –ø—Ä–∏–Ω—è—Ç–∞`);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    if (this.socket) {
                        this.socket.emit('speedcash_place_bet', {
                            color: color,
                            amount: betAmount,
                            multiplier: color === 'blue' ? this.blueMultiplier : this.orangeMultiplier
                        });
                    }
                }
            }
            return;
        }
        
        // –í–æ –≤—Ä–µ–º—è racing —Ñ–∞–∑—ã
        if (this.gameState === 'racing') {
            if (currentBet) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–¥–µ—Ä–∂–∞–Ω–∞ –ª–∏ –º–∞—à–∏–Ω–∞
                const isDetained = (color === 'blue' && this.blueDetained) || (color === 'orange' && this.orangeDetained);
                if (isDetained) {
                    // –ö–Ω–æ–ø–∫–∞ —É–∂–µ disabled, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                    return;
                }
                // –ï—Å—Ç—å —Å—Ç–∞–≤–∫–∞ –∏ –º–∞—à–∏–Ω–∞ –Ω–µ –∑–∞–¥–µ—Ä–∂–∞–Ω–∞ - –¥–µ–ª–∞–µ–º Cash Out
                this.cashOut(color);
            }
            // –ù–µ—Ç —Å—Ç–∞–≤–∫–∏ –≤–æ –≤—Ä–µ–º—è racing - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º (–∫–Ω–æ–ø–∫–∞ disabled)
            return;
        }
    }

    cancelBet(color) {
        const betAmount = color === 'blue' ? this.currentBlueBet : this.currentOrangeBet;
        if (!betAmount) return;
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞
        if (window.GameBalanceAPI) {
            window.GameBalanceAPI.payWinningsAndUpdate(betAmount, 'chips');
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
        if (color === 'blue') {
            this.currentBlueBet = null;
        } else {
            this.currentOrangeBet = null;
        }
        
        const amount = color === 'blue' ? this.blueBet : this.orangeBet;
        this.updateBetButton(color, 'bet', amount);
        console.log(`‚ùå –°—Ç–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞: ${color} - ${betAmount} chips`);
    }

    cashOut(color) {
        const betAmount = color === 'blue' ? this.currentBlueBet : this.currentOrangeBet;
        if (!betAmount) return;
        
        const multiplier = color === 'blue' ? this.blueMultiplier : this.orangeMultiplier;
        const winnings = Math.floor(betAmount * multiplier);
        
        // –í—ã–ø–ª–∞—á–∏–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à
        if (window.GameBalanceAPI) {
            window.GameBalanceAPI.payWinningsAndUpdate(winnings, 'chips');
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
        if (color === 'blue') {
            this.currentBlueBet = null;
        } else {
            this.currentOrangeBet = null;
        }
        
        const amount = color === 'blue' ? this.blueBet : this.orangeBet;
        this.updateBetButton(color, 'bet', amount);
        console.log(`üí∞ ${color} Cash Out: ${winnings} chips (x${multiplier.toFixed(2)})`);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        if (this.socket) {
            this.socket.emit('speedcash_cashout', {
                color: color,
                multiplier: multiplier,
                winnings: winnings
            });
        }
    }

    updateBetButton(color, state, amount, disabled = false) {
        const button = this.getButton(color);
        const wrapper = this.getButtonWrapper(color);
        if (!button) return;
        
        const textElement = button.querySelector('.text-wrapper-9');
        const amountElement = button.querySelector(color === 'blue' ? '.text-wrapper-10' : '.text-wrapper-14');
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
        button.classList.remove('state-bet', 'state-cancel', 'state-cashout', 'disabled');
        if (wrapper) {
            wrapper.classList.remove('state-bet', 'state-cancel', 'state-cashout', 'disabled');
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º disabled –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (disabled) {
            button.classList.add('disabled');
            if (wrapper) wrapper.classList.add('disabled');
            button.style.opacity = '0.5';
            button.style.pointerEvents = 'none';
        } else {
            button.style.opacity = '';
            button.style.pointerEvents = '';
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if (state === 'bet') {
            if (textElement) textElement.textContent = 'Bet';
            if (amountElement) amountElement.textContent = `${amount} Chips`;
            button.classList.add('state-bet');
            if (wrapper) wrapper.classList.add('state-bet');
        } else if (state === 'cancel') {
            if (textElement) textElement.textContent = 'Cancel';
            if (amountElement) amountElement.textContent = '';
            button.classList.add('state-cancel');
            if (wrapper) wrapper.classList.add('state-cancel');
        } else if (state === 'cashout') {
            if (textElement) textElement.textContent = 'Cash Out';
            if (amountElement) amountElement.textContent = `${amount} Chips`;
            button.classList.add('state-cashout');
            if (wrapper) wrapper.classList.add('state-cashout');
        }
    }
    
    getButton(color) {
        return color === 'blue' 
            ? document.querySelector('.div-4:first-child .bet-button')
            : document.querySelector('.div-4:last-child .cash-out-button');
    }
    
    getButtonWrapper(color) {
        return color === 'blue'
            ? document.querySelector('.div-4:first-child .div-wrapper-3')
            : document.querySelector('.div-4:last-child .div-wrapper-3');
    }

    startRace() {
        this.gameState = 'racing';
        this.raceStartTime = Date.now();
        this.startTime = this.raceStartTime;
        this.racePhaseEndTime = this.raceStartTime + 8000;
        this.gameEnded = false;
        this.blueEscaped = false;
        this.orangeEscaped = false;
        this.escapeTextShown = false;
        this.blueDetained = false;
        this.orangeDetained = false;
        this.lastMultiplierUpdate = 0;
        
        // Use cached elements
        if (this.raceArea) {
            this.raceArea.classList.remove('countdown-mode');
            this.raceArea.classList.add('game-active');
        }
        
        if (this.roadLinesContainer) {
            this.roadLinesContainer.classList.add('visible');
        }
        
        // Reset positions and set initial multipliers
        this.bluePosition = 0;
        this.orangePosition = 0;
        
        // –°—Ä–∞–∑—É —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –º–∞—à–∏–Ω –≤ DOM —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–µ—Ä–≥–∞–Ω–∏—è
        if (this.blueCar) {
            this.blueCar.style.transform = 'translate3d(0, 0px, 0)';
        }
        if (this.orangeCar) {
            this.orangeCar.style.transform = 'translate3d(0, 0px, 0)';
        }
        
        this.blueMultiplier = 1.00;
        this.orangeMultiplier = 1.00;
        this.updateMultiplierDisplays();
        
        // –†–∞–Ω–¥–æ–º–Ω—ã–µ –∏–∫—Å—ã –¥–ª—è –æ–±–µ–∏—Ö –º–∞—à–∏–Ω (2.0 - 8.0)
        this.blueTargetMultiplier = 2.0 + Math.random() * 6.0;
        this.orangeTargetMultiplier = 2.0 + Math.random() * 6.0;
        
        // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –∏–∫—Å—ã —Ä–∞–∑–Ω—ã–µ (–º–∏–Ω–∏–º—É–º 0.3 —Ä–∞–∑–Ω–∏—Ü—ã)
        while (Math.abs(this.blueTargetMultiplier - this.orangeTargetMultiplier) < 0.3) {
            this.orangeTargetMultiplier = 2.0 + Math.random() * 6.0;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ç–æ –±—É–¥–µ—Ç –∑–∞–¥–µ—Ä–∂–∞–Ω
        // 98.5% - –æ–¥–Ω–∞ –º–∞—à–∏–Ω–∞, 1.5% - –æ–±–µ –º–∞—à–∏–Ω—ã
        const bothDetained = Math.random() < 0.015;
        
        if (bothDetained) {
            this.delayedCar = 'both';
            console.log('üöîüöî –û–±–µ –º–∞—à–∏–Ω—ã –±—É–¥—É—Ç –∑–∞–¥–µ—Ä–∂–∞–Ω—ã!');
        } else {
            // –ó–∞–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç—É, —É –∫–æ—Ç–æ—Ä–æ–π –º–µ–Ω—å—à–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å
            this.delayedCar = this.blueTargetMultiplier < this.orangeTargetMultiplier ? 'blue' : 'orange';
        }
        
        console.log(`üé≤ Blue target: x${this.blueTargetMultiplier.toFixed(2)}, Orange target: x${this.orangeTargetMultiplier.toFixed(2)}`);
        console.log(`üöî Delayed car: ${this.delayedCar}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ Cash Out –µ—Å–ª–∏ —Å—Ç–∞–≤–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω—ã (disabled = false, —Ç–∞–∫ –∫–∞–∫ –≤ –Ω–∞—á–∞–ª–µ –≥–æ–Ω–∫–∏ –º–∞—à–∏–Ω—ã –µ—â–µ –Ω–µ –∑–∞–¥–µ—Ä–∂–∞–Ω—ã)
        // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞–≤–∫–∏ - –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è disabled
        if (this.currentBlueBet) {
            this.updateBetButton('blue', 'cashout', this.currentBlueBet, false);
        } else {
            this.updateBetButton('blue', 'bet', this.blueBet, true);
        }
        if (this.currentOrangeBet) {
            this.updateBetButton('orange', 'cashout', this.currentOrangeBet, false);
        } else {
            this.updateBetButton('orange', 'bet', this.orangeBet, true);
        }
        if (this.currentSingleBet) {
            this.updateSingleButton('cashout', this.currentSingleBet, false);
        } else {
            this.updateSingleButton('bet', this.singleBet, true);
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤—ã—Ö
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
            this.animationId = null;
        }
        if (this.roadAnimationId) {
            cancelAnimationFrame(this.roadAnimationId);
            this.roadAnimationId = null;
        }
        
        // Start animations
        this.animateRace();
        this.animateRoadLines();
    }

    animateRace() {
        if (this.gameState !== 'racing') return;
        
        const currentTime = Date.now();
        const elapsed = currentTime - this.startTime;
        
        // Determine racing phase (first 8 seconds)
        this.racingPhase = currentTime < this.racePhaseEndTime;
        
        // Determine delayed status only AFTER racing phase ends
        const blueDelayed = !this.racingPhase && (this.delayedCar === 'blue' || this.delayedCar === 'both');
        const orangeDelayed = !this.racingPhase && (this.delayedCar === 'orange' || this.delayedCar === 'both');

        // Increment multipliers ONLY in local mode (no server)
        if (!this.gameEnded && !this.socket) {
            const baseIncrease = 0.00015 + Math.random() * 0.00025;

            // Blue –º–Ω–æ–∂–∏—Ç–µ–ª—å
            if (!blueDelayed && !this.blueEscaped && this.blueMultiplier < this.blueTargetMultiplier) {
                this.blueMultiplier += baseIncrease;
                if (this.blueMultiplier >= this.blueTargetMultiplier) {
                    this.blueMultiplier = this.blueTargetMultiplier;
                }
            }

            // Orange –º–Ω–æ–∂–∏—Ç–µ–ª—å
            if (!orangeDelayed && !this.orangeEscaped && this.orangeMultiplier < this.orangeTargetMultiplier) {
                this.orangeMultiplier += baseIncrease;
                if (this.orangeMultiplier >= this.orangeTargetMultiplier) {
                    this.orangeMultiplier = this.orangeTargetMultiplier;
                }
            }
        }
        
        // Throttle updates - only update every 50ms for better performance
        if (currentTime - this.lastMultiplierUpdate >= this.multiplierUpdateInterval) {
            this.updateMultiplierDisplays();
            this.updateLiveWinnings();
            this.checkAutoCashOut();
            this.lastMultiplierUpdate = currentTime;
        }
        
        // –î–≤–∏–∂–µ–Ω–∏–µ –º–∞—à–∏–Ω - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        if (this.isMobile) {
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ 2 sin –≤–º–µ—Å—Ç–æ 6)
            const t = elapsed * 0.001;
            
            // Blue car movement
            if (this.blueEscaped) {
                this.bluePosition -= 8;
            } else if (this.blueDetained) {
                this.bluePosition += 5;
            } else {
                const blueTarget = Math.sin(t) * 30;
                this.bluePosition += (blueTarget - this.bluePosition) * 0.06;
            }
            
            // Orange car movement
            if (this.orangeEscaped) {
                this.orangePosition -= 8;
            } else if (this.orangeDetained) {
                this.orangePosition += 5;
            } else {
                const orangeTarget = Math.sin(t * 1.2) * 30;
                this.orangePosition += (orangeTarget - this.orangePosition) * 0.06;
            }
        } else {
            // –ü–æ–ª–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
            const t1 = elapsed * 0.0008;
            const t2 = elapsed * 0.0013;
            const t3 = elapsed * 0.0019;
            const t4 = elapsed * 0.0011;
            const t5 = elapsed * 0.0017;
            const t6 = elapsed * 0.0023;
            
            // Blue car movement
            if (this.blueEscaped) {
                this.bluePosition -= 8;
            } else if (this.blueDetained) {
                this.bluePosition += 5;
            } else {
                const blueTarget = Math.sin(t1) * 25 + Math.cos(t2) * 15 + Math.sin(t3) * 10;
                this.bluePosition += (blueTarget - this.bluePosition) * 0.04;
            }
            
            // Orange car movement
            if (this.orangeEscaped) {
                this.orangePosition -= 8;
            } else if (this.orangeDetained) {
                this.orangePosition += 5;
            } else {
                const orangeTarget = Math.sin(t4) * 20 + Math.cos(t5) * 18 + Math.sin(t6) * 12;
                this.orangePosition += (orangeTarget - this.orangePosition) * 0.04;
            }
        }
        
        // Use GPU-accelerated transforms with translate3d
        if (this.blueCar) {
            this.blueCar.style.transform = `translate3d(0, ${this.bluePosition}px, 0)`;
        }
        if (this.orangeCar) {
            this.orangeCar.style.transform = `translate3d(0, ${this.orangePosition}px, 0)`;
        }
        
        // Continue animation
        this.animationId = requestAnimationFrame(() => this.animateRace());
    }

    showCrashIcon(color, carPosition) {
        // Show crash icon only once per car
        const iconId = `crash-icon-${color}`;
        if (document.getElementById(iconId)) return;
        
        const icon = document.createElement('div');
        icon.id = iconId;
        icon.className = 'crash-icon';
        const leftPosition = color === 'blue' ? '25%' : '75%';
        // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –∏–∫–æ–Ω–æ–∫ –∑–∞–¥–µ—Ä–∂–∞–Ω–∏—è
        icon.style.cssText = `
            position: absolute;
            top: 60%;
            left: ${leftPosition};
            transform: translate(-50%, -50%);
            z-index: 50;
            text-align: center;
        `;
        
        const img = document.createElement('img');
        img.src = color === 'blue'
            ? 'https://github.com/Pacific1a/img/blob/main/speedcash/blue.webp?raw=true'
            : 'https://github.com/Pacific1a/img/blob/main/speedcash/orange.webp?raw=true';
        img.style.cssText = `
            width: 60px;
            height: 60px;
            border-radius: 8px;
        `;
        
        const text = document.createElement('div');
        text.textContent = '–ó–∞–¥–µ—Ä–∂–∞–Ω';
        text.style.cssText = `
            color: ${color === 'blue' ? '#244eb6' : '#c44c13'};
            font-family: 'Montserrat', Helvetica;
            font-weight: 600;
            font-size: 14px;
            margin-top: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        `;
        
        icon.appendChild(img);
        icon.appendChild(text);
        document.querySelector('.game').appendChild(icon);
    }
    
    

    
    
    showEscapeText(color) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –º–∞—à–∏–Ω–∞ —É–µ—Ö–∞–ª–∞
        if (this.delayedCar === 'both') {
            // –ï—Å–ª–∏ –æ–±–µ –∑–∞–¥–µ—Ä–∂–∞–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
            console.log('üö´ –û–±–µ –º–∞—à–∏–Ω—ã –∑–∞–¥–µ—Ä–∂–∞–Ω—ã - –∏–≥—Ä–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è');
            this.showBothDetainedScreen();
            return;
        }
        
        const escapeElement = document.createElement('div');
        escapeElement.className = 'escape-text';
        escapeElement.textContent = '–£–ï–•–ê–õ!';
        
        // Position based on which car escaped
        if (color === 'blue') {
            escapeElement.style.left = '25%'; // Left side for blue car
        } else {
            escapeElement.style.left = '75%'; // Right side for orange car
        }
        
        document.querySelector('.race').appendChild(escapeElement);
        
        // Show the text
        setTimeout(() => {
            escapeElement.classList.add('show');
        }, 100);
        
        // Remove after 1.5 seconds and show DROVE AWAY screen
        setTimeout(() => {
            if (escapeElement.parentNode) {
                escapeElement.parentNode.removeChild(escapeElement);
            }
            this.showDroveAwayScreen();
        }, 1500);
    }

    showBothDetainedScreen() {
        // –≠–∫—Ä–∞–Ω –∫–æ–≥–¥–∞ –æ–±–µ –º–∞—à–∏–Ω—ã –∑–∞–¥–µ—Ä–∂–∞–Ω—ã
        const detainedScreen = document.createElement('div');
        detainedScreen.className = 'drove-away-screen';
        detainedScreen.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgb(0, 0, 0) 0%, rgb(15.3, 15.3, 15.3) 100%);
            z-index: 200;
        `;
        
        const detainedText = document.createElement('div');
        detainedText.textContent = 'BOTH DETAINED';
        detainedText.style.cssText = `
            font-size: 17px;
            font-weight: 600;
            color: #ff6b6b;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: droveAwayPulse 1s ease-in-out;
        `;
        
        detainedScreen.appendChild(detainedText);
        document.querySelector('.race').appendChild(detainedScreen);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤ Bet
        this.currentBlueBet = null;
        this.currentOrangeBet = null;
        this.currentSingleBet = null;
        this.updateBetButton('blue', 'bet', this.blueBet);
        this.updateBetButton('orange', 'bet', this.orangeBet);
        this.updateSingleButton('bet', this.singleBet);
        
        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º –∏–≥—Ä—É
        setTimeout(() => {
            if (detainedScreen.parentNode) {
                detainedScreen.parentNode.removeChild(detainedScreen);
            }
            this.endGame();
        }, 1500);
    }

    showDroveAwayScreen() {
        // –°–æ–∑–¥–∞–µ–º —ç–∫—Ä–∞–Ω DROVE AWAY (–∫–∞–∫ waiting screen)
        const droveAwayScreen = document.createElement('div');
        droveAwayScreen.className = 'drove-away-screen';
        droveAwayScreen.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgb(0, 0, 0) 0%, rgb(15.3, 15.3, 15.3) 100%);
            z-index: 200;
        `;
        
        const droveAwayText = document.createElement('div');
        droveAwayText.textContent = 'DROVE AWAY';
        droveAwayText.style.cssText = `
            font-size: 17px;
            font-weight: 600;
            color: white;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: droveAwayPulse 1s ease-in-out;
        `;
        
        droveAwayScreen.appendChild(droveAwayText);
        document.querySelector('.race').appendChild(droveAwayScreen);
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é
        if (!document.getElementById('droveAwayAnimation')) {
            const style = document.createElement('style');
            style.id = 'droveAwayAnimation';
            style.textContent = `
                @keyframes droveAwayPulse {
                    0% { opacity: 0; }
                    100% { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º –∏–≥—Ä—É
        setTimeout(() => {
            if (droveAwayScreen.parentNode) {
                droveAwayScreen.parentNode.removeChild(droveAwayScreen);
            }
            this.endGame();
        }, 1000);
    }

    endGame() {
        this.gameState = 'finished';
        this.gameEnded = true;
        
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
        }
        if (this.roadAnimationId) {
            cancelAnimationFrame(this.roadAnimationId);
        }
        
        // Start smooth transition after escape text is shown
        setTimeout(() => {
            this.startTransition();
        }, 2000);
    }
    
    startTransition() {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
        this.addToHistory(this.finalBlueMultiplier || this.blueMultiplier, this.finalOrangeMultiplier || this.orangeMultiplier);
        
        // Calculate winnings (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏)
        let winnings = 0;
        if (this.currentBlueBet && this.blueEscaped) {
            winnings += this.currentBlueBet * (this.finalBlueMultiplier || this.blueMultiplier);
        }
        if (this.currentOrangeBet && this.orangeEscaped) {
            winnings += this.currentOrangeBet * (this.finalOrangeMultiplier || this.orangeMultiplier);
        }
        
        // –í—ã–ø–ª–∞—á–∏–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
        if (winnings > 0 && window.GameBalanceAPI) {
            window.GameBalanceAPI.payWinningsAndUpdate(winnings, 'chips');
            console.log(`–í—ã–ø–ª–∞—á–µ–Ω –≤—ã–∏–≥—Ä—ã—à: ${winnings} —á–∏–ø–æ–≤`);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Single mode –≤—ã–∏–≥—Ä—ã—à (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏)
        if (this.currentSingleBet) {
            const selectedCarEscaped = (this.singleSelectedCar === 'blue' && this.blueEscaped) || 
                                       (this.singleSelectedCar === 'orange' && this.orangeEscaped);
            
            if (selectedCarEscaped) {
                const multiplier = this.singleSelectedCar === 'blue' ? 
                    (this.finalBlueMultiplier || this.blueMultiplier) : 
                    (this.finalOrangeMultiplier || this.orangeMultiplier);
                const singleWinnings = Math.floor(this.currentSingleBet * multiplier * 1.5);
                if (window.GameBalanceAPI) {
                    window.GameBalanceAPI.payWinningsAndUpdate(singleWinnings, 'chips');
                    console.log(`üéØ Single –≤—ã–∏–≥—Ä—ã—à: ${singleWinnings} chips (x${multiplier.toFixed(2)} √ó 1.5)`);
                }
            } else {
                console.log(`‚ùå Single —Å—Ç–∞–≤–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞`);
            }
        }
        
        // Reset bets
        this.currentBlueBet = null;
        this.currentOrangeBet = null;
        this.currentSingleBet = null;
        
        // Reset bet buttons
        this.updateBetButton('blue', 'bet', this.blueBet);
        this.updateBetButton('orange', 'bet', this.orangeBet);
        this.updateSingleButton('bet', this.singleBet);
        
        // Reset multipliers
        this.blueMultiplier = 1.00;
        this.orangeMultiplier = 1.00;
        this.updateMultiplierDisplays();
        
        // Reset car positions –°–†–ê–ó–£
        if (this.blueCar) {
            this.blueCar.style.transform = 'translateY(0px)';
        }
        if (this.orangeCar) {
            this.orangeCar.style.transform = 'translateY(0px)';
        }
        
        // Clear any crash icons –°–†–ê–ó–£
        const existingIcons = document.querySelectorAll('.crash-icon');
        existingIcons.forEach(icon => icon.remove());
        
        // –°–†–ê–ó–£ —Å–∫—Ä—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º countdown
        const raceArea = document.querySelector('.race');
        if (raceArea) {
            raceArea.classList.remove('game-active');
            raceArea.classList.add('countdown-mode');
        }
        
        const roadLines = document.getElementById('roadLines');
        if (roadLines) {
            roadLines.classList.remove('visible');
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é —Ñ–∞–∑—É betting –ë–ï–ó –∑–∞–¥–µ—Ä–∂–∫–∏
        this.startBettingPhase();
    }

    updateMultiplierDisplays() {
        if (this.blueMultiplierDisplay && this.blueMultiplier !== undefined) {
            this.blueMultiplierDisplay.textContent = `x${this.blueMultiplier.toFixed(2)}`;
        }
        if (this.orangeMultiplierDisplay && this.orangeMultiplier !== undefined) {
            this.orangeMultiplierDisplay.textContent = `x${this.orangeMultiplier.toFixed(2)}`;
        }
    }

    updateLiveWinnings() {
        // Blue live winnings
        if (this.currentBlueBet && this.gameState === 'racing' && this.blueMultiplier !== undefined) {
            const blueWinnings = Math.floor(this.currentBlueBet * this.blueMultiplier);
            const blueDisabled = this.blueDetained || this.blueEscaped;
            this.updateBetButton('blue', 'cashout', blueWinnings, blueDisabled);
        }
        
        // Orange live winnings
        if (this.currentOrangeBet && this.gameState === 'racing' && this.orangeMultiplier !== undefined) {
            const orangeWinnings = Math.floor(this.currentOrangeBet * this.orangeMultiplier);
            const orangeDisabled = this.orangeDetained || this.orangeEscaped;
            this.updateBetButton('orange', 'cashout', orangeWinnings, orangeDisabled);
        }
        
        // Single live winnings
        if (this.currentSingleBet && this.gameState === 'racing') {
            const multiplier = this.singleSelectedCar === 'blue' ? this.blueMultiplier : this.orangeMultiplier;
            if (multiplier !== undefined) {
                const singleWinnings = Math.floor(this.currentSingleBet * multiplier * 1.5);
                const singleDisabled = (this.singleSelectedCar === 'blue' && (this.blueDetained || this.blueEscaped)) || 
                                       (this.singleSelectedCar === 'orange' && (this.orangeDetained || this.orangeEscaped));
                this.updateSingleButton('cashout', singleWinnings, singleDisabled);
            }
        }
    }

    checkAutoCashOut() {
        // Blue auto cash out
        if (this.currentBlueBet && this.blueAutoCashOutEnabled && this.blueMultiplier !== undefined && !this.blueDetained) {
            if (this.blueMultiplier >= this.blueAutoCashOutMultiplier) {
                this.cashOut('blue');
                console.log(`ü§ñ Blue Auto Cash Out at x${this.blueMultiplier.toFixed(2)}`);
            }
        }
        
        // Orange auto cash out
        if (this.currentOrangeBet && this.orangeAutoCashOutEnabled && this.orangeMultiplier !== undefined && !this.orangeDetained) {
            if (this.orangeMultiplier >= this.orangeAutoCashOutMultiplier) {
                this.cashOut('orange');
                console.log(`ü§ñ Orange Auto Cash Out at x${this.orangeMultiplier.toFixed(2)}`);
            }
        }
    }

    showCountdown() {
        // Countdown is handled by the waiting-circle HTML elements
        console.log('Countdown started');
    }
    
    updateCountdown() {
        // Use cached element
        if (this.countdownText) {
            this.countdownText.textContent = this.bettingTimeLeft;
        }
    }
    
    hideCountdown() {
        const countdownText = document.querySelector('.countdown-text');
        const countdownLabel = document.querySelector('.countdown-label');
        if (countdownText && countdownLabel) {
            countdownText.textContent = 'GO!';
            countdownLabel.textContent = '–ü–û–ï–•–ê–õ–ò';
        }
    }

    adjustBetAmount(color, action) {
        // Single mode
        if (color === 'single') {
            if (this.gameState !== 'betting') return;
            
            if (action === 'half') {
                this.singleBet = Math.max(10, Math.floor(this.singleBet / 2));
            } else if (action === 'double') {
                this.singleBet = this.singleBet * 2;
            } else {
                this.singleBet = Math.max(10, this.singleBet + action);
            }
            
            const singleAmountDisplay = document.querySelector('.who-is-win .text-wrapper-13');
            if (singleAmountDisplay) {
                singleAmountDisplay.textContent = this.singleBet;
            }
            
            if (!this.currentSingleBet) {
                this.updateSingleButton('bet', this.singleBet);
            }
            return;
        }
        
        // –†–∞–∑—Ä–µ—à–∞–µ–º –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞–≤–∫—É —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è betting
        if (this.gameState !== 'betting') return;
        
        if (color === 'blue') {
            if (action === 'half') {
                this.blueBet = Math.max(10, Math.floor(this.blueBet / 2));
            } else if (action === 'double') {
                this.blueBet = this.blueBet * 2;
            } else {
                this.blueBet = Math.max(10, this.blueBet + action);
            }
            if (this.blueBetAmount) {
                this.blueBetAmount.textContent = this.blueBet;
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –≤ –∫–Ω–æ–ø–∫–µ –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–≤–∫–∏
            if (!this.currentBlueBet) {
                this.updateBetButton('blue', 'bet', this.blueBet);
            }
        } else if (color === 'orange') {
            if (action === 'half') {
                this.orangeBet = Math.max(10, Math.floor(this.orangeBet / 2));
            } else if (action === 'double') {
                this.orangeBet = this.orangeBet * 2;
            } else {
                this.orangeBet = Math.max(10, this.orangeBet + action);
            }
            if (this.orangeBetAmount) {
                this.orangeBetAmount.textContent = this.orangeBet;
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –≤ –∫–Ω–æ–ø–∫–µ –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–≤–∫–∏
            if (!this.currentOrangeBet) {
                this.updateBetButton('orange', 'bet', this.orangeBet);
            }
        }
    }

    placeSingleBet() {
        // –í–æ –≤—Ä–µ–º—è betting —Ñ–∞–∑—ã
        if (this.gameState === 'betting') {
            if (this.currentSingleBet) {
                // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–≤–∫—É (Cancel)
                this.cancelSingleBet();
            } else {
                // –°—Ç–∞–≤–∏–º –Ω–æ–≤—É—é —Å—Ç–∞–≤–∫—É
                if (!window.GameBalanceAPI || !window.GameBalanceAPI.canPlaceBet(this.singleBet, 'chips')) {
                    this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                    return;
                }
                const success = window.GameBalanceAPI.placeBet(this.singleBet, 'chips');
                if (success) {
                    this.currentSingleBet = this.singleBet;
                    this.updateSingleButton('cancel', this.singleBet);
                    console.log(`‚úÖ Single —Å—Ç–∞–≤–∫–∞ ${this.singleBet} —á–∏–ø–æ–≤ –Ω–∞ ${this.singleSelectedCar} –ø—Ä–∏–Ω—è—Ç–∞`);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    if (this.socket) {
                        this.socket.emit('speedcash_place_bet', {
                            color: this.singleSelectedCar,
                            amount: this.singleBet,
                            mode: 'single',
                            multiplier: this.singleSelectedCar === 'blue' ? this.blueMultiplier : this.orangeMultiplier
                        });
                    }
                }
            }
            return;
        }
        
        // –í–æ –≤—Ä–µ–º—è racing —Ñ–∞–∑—ã
        if (this.gameState === 'racing') {
            if (this.currentSingleBet) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–¥–µ—Ä–∂–∞–Ω–∞ –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–∞—à–∏–Ω–∞
                const isDetained = (this.singleSelectedCar === 'blue' && this.blueDetained) || 
                                   (this.singleSelectedCar === 'orange' && this.orangeDetained);
                if (isDetained) {
                    // –ö–Ω–æ–ø–∫–∞ —É–∂–µ disabled, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                    return;
                }
                // Cash Out –¥–ª—è Single mode
                this.cashOutSingle();
            }
            // –ù–µ—Ç —Å—Ç–∞–≤–∫–∏ –≤–æ –≤—Ä–µ–º—è racing - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º (–∫–Ω–æ–ø–∫–∞ disabled)
            return;
        }
    }

    cashOutSingle() {
        if (!this.currentSingleBet) return;
        
        const multiplier = this.singleSelectedCar === 'blue' ? this.blueMultiplier : this.orangeMultiplier;
        const winnings = Math.floor(this.currentSingleBet * multiplier * 1.5);
        
        // –í—ã–ø–ª–∞—á–∏–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à
        if (window.GameBalanceAPI) {
            window.GameBalanceAPI.payWinningsAndUpdate(winnings, 'chips');
        }
        
        this.currentSingleBet = null;
        this.updateSingleButton('bet', this.singleBet);
        console.log(`üí∞ Single Cash Out: ${winnings} chips (x${multiplier.toFixed(2)} √ó 1.5)`);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        if (this.socket) {
            this.socket.emit('speedcash_cashout', {
                color: this.singleSelectedCar,
                multiplier: multiplier,
                winnings: winnings,
                mode: 'single'
            });
        }
    }

    cancelSingleBet() {
        if (!this.currentSingleBet) return;
        if (window.GameBalanceAPI) {
            window.GameBalanceAPI.payWinningsAndUpdate(this.currentSingleBet, 'chips');
        }
        this.currentSingleBet = null;
        this.updateSingleButton('bet', this.singleBet);
        console.log(`‚ùå Single —Å—Ç–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞`);
    }



    updateSingleButton(state, amount, disabled = false) {
        const button = document.querySelector('.who-is-win .bet-button');
        if (!button) return;
        
        const textElement = button.querySelector('.text-wrapper-9');
        const amountElement = button.querySelector('.text-wrapper-10');
        
        button.classList.remove('state-bet', 'state-cancel', 'state-cashout', 'disabled');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º disabled –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (disabled) {
            button.classList.add('disabled');
            button.style.opacity = '0.5';
            button.style.pointerEvents = 'none';
        } else {
            button.style.opacity = '';
            button.style.pointerEvents = '';
        }
        
        if (state === 'bet') {
            if (textElement) textElement.textContent = 'Bet';
            if (amountElement) amountElement.textContent = `${amount} Chips`;
            button.classList.add('state-bet');
        } else if (state === 'cancel') {
            if (textElement) textElement.textContent = 'Cancel';
            if (amountElement) amountElement.textContent = '';
            button.classList.add('state-cancel');
        } else if (state === 'cashout') {
            if (textElement) textElement.textContent = 'Cash Out';
            if (amountElement) amountElement.textContent = `${amount} Chips`;
            button.classList.add('state-cashout');
        }
    }

    selectSingleCar(car) {
        this.singleSelectedCar = car;
        const blueTab = document.querySelector('.who-is-win .plays .div-wrapper-2:first-child');
        const orangeTab = document.querySelector('.who-is-win .plays .div-wrapper-2:last-child');
        
        if (car === 'blue') {
            if (blueTab) blueTab.innerHTML = '<div class="selected"><div class="text-wrapper-6">Blue</div></div>';
            if (orangeTab) orangeTab.innerHTML = '<div class="not-selected"><div class="text-wrapper-6">Orange</div></div>';
        } else {
            if (blueTab) blueTab.innerHTML = '<div class="not-selected"><div class="text-wrapper-6">Blue</div></div>';
            if (orangeTab) orangeTab.innerHTML = '<div class="selected"><div class="text-wrapper-6">Orange</div></div>';
        }
        console.log(`üéØ –í—ã–±—Ä–∞–Ω–∞ –º–∞—à–∏–Ω–∞: ${car}`);
    }

    addToHistory(blueMultiplier, orangeMultiplier) {
        const streak = document.querySelector('.streak');
        if (!streak) return;
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏
        const historyItem = document.createElement('div');
        historyItem.className = 'div-5';
        historyItem.innerHTML = `
            <div class="text-wrapper-15" style="color: #244eb6;">x${blueMultiplier.toFixed(2)}</div>
            <div class="text-wrapper-16" style="color: #c44c14;">x${orangeMultiplier.toFixed(2)}</div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
        streak.insertBefore(historyItem, streak.firstChild);
        
        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        while (streak.children.length > 10) {
            streak.removeChild(streak.lastChild);
        }
    }
}

// Global game object
let gameInstance = null;

// Initialize game when page loads
document.addEventListener('DOMContentLoaded', () => {
    gameInstance = new SpeedCashGame();
    
    // Setup mode switching and auto cash out
    setupModeSwitching();
    setupAutoCashOut();
});

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ Crash / Single
function setupModeSwitching() {
    const crashTab = document.querySelector('.crash-section-2 .div-wrapper-2:first-child');
    const singleTab = document.querySelector('.crash-section-2 .div-wrapper-2:last-child');
    const betsContainer = document.querySelector('.bets');
    const whoIsWinContainer = document.querySelector('.who-is-win');
    
    if (!crashTab || !singleTab) return;
    
    // Crash mode (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    crashTab.addEventListener('click', () => {
        // –°—Ç–∏–ª–∏ –¥–ª—è Crash (selected)
        crashTab.innerHTML = '<div class="selected"><div class="text-wrapper-6">Crash</div></div>';
        // –°—Ç–∏–ª–∏ –¥–ª—è Single (not-selected)
        singleTab.innerHTML = '<div class="not-selected"><img class="vector" src="https://raw.githubusercontent.com/Pacific1a/img/6768186bd224ed8383ca478d1363a8b40b694805/speedcash/vector.svg" /></div>';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º bets, —Å–∫—Ä—ã–≤–∞–µ–º who-is-win
        if (betsContainer) betsContainer.style.display = 'flex';
        if (whoIsWinContainer) whoIsWinContainer.style.display = 'none';
    });
    
    // Single mode
    singleTab.addEventListener('click', () => {
        // –°—Ç–∏–ª–∏ –¥–ª—è Single (selected)
        const selectedDiv = document.createElement('div');
        selectedDiv.className = 'selected';
        selectedDiv.style.borderRadius = '13.5px';
        selectedDiv.style.background = 'linear-gradient(90deg, rgba(35, 35, 35, 1) 0%, rgba(46, 46, 46, 1) 100%)';
        selectedDiv.innerHTML = '<img class="vector" src="https://raw.githubusercontent.com/Pacific1a/img/6768186bd224ed8383ca478d1363a8b40b694805/speedcash/vector.svg" style="filter: brightness(1.5);" />';
        singleTab.innerHTML = '';
        singleTab.appendChild(selectedDiv);
        
        // –°—Ç–∏–ª–∏ –¥–ª—è Crash (not-selected)
        crashTab.innerHTML = '<div class="not-selected"><div class="text-wrapper-6">Crash</div></div>';
        
        // –°–∫—Ä—ã–≤–∞–µ–º bets, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º who-is-win
        if (betsContainer) betsContainer.style.display = 'none';
        if (whoIsWinContainer) whoIsWinContainer.style.display = 'flex';
    });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∫–µ—à–∞—É—Ç–∞
function setupAutoCashOut() {
    setupAutoCashOutForColor('blue');
    setupAutoCashOutForColor('orange');
}

function setupAutoCashOutForColor(color) {
    const selector = color === 'blue' 
        ? '.div-4:first-child' 
        : '.div-4:last-child';
    
    const container = document.querySelector(selector);
    if (!container) return;
    
    const toggleBtn = container.querySelector('.div-6');
    const multiplierInput = container.querySelector('.text-wrapper-12');
    
    if (!toggleBtn || !multiplierInput) return;
    
    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω
    toggleBtn.style.opacity = '0.5';
    toggleBtn.style.cursor = 'pointer';
    let isEnabled = false;
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª/–≤—ã–∫–ª
    toggleBtn.addEventListener('click', () => {
        isEnabled = !isEnabled;
        toggleBtn.style.opacity = isEnabled ? '1' : '0.5';
        
        if (gameInstance) {
            if (color === 'blue') {
                gameInstance.blueAutoCashOutEnabled = isEnabled;
            } else {
                gameInstance.orangeAutoCashOutEnabled = isEnabled;
            }
        }
        
        console.log(`${color} Auto Cash Out: ${isEnabled ? 'ON' : 'OFF'}`);
    });
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è
    multiplierInput.contentEditable = 'true';
    multiplierInput.style.cursor = 'text';
    
    multiplierInput.addEventListener('focus', (e) => {
        const text = e.target.textContent;
        if (text.startsWith('x')) {
            e.target.textContent = text.substring(1);
        }
        // –í—ã–¥–µ–ª—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç
        const range = document.createRange();
        range.selectNodeContents(e.target);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    });
    
    multiplierInput.addEventListener('blur', (e) => {
        let value = parseFloat(e.target.textContent.replace(/[^0-9.]/g, ''));
        if (isNaN(value) || value < 1.01) value = 2.00;
        e.target.textContent = `x${value.toFixed(2)}`;
        
        if (gameInstance) {
            if (color === 'blue') {
                gameInstance.blueAutoCashOutMultiplier = value;
            } else {
                gameInstance.orangeAutoCashOutMultiplier = value;
            }
        }
    });
    
    multiplierInput.addEventListener('keydown', (e) => {
        const allowed = ['0','1','2','3','4','5','6','7','8','9','.','Backspace','Delete','ArrowLeft','ArrowRight','Tab'];
        if (!allowed.includes(e.key)) {
            e.preventDefault();
        }
        if (e.key === 'Enter') {
            e.preventDefault();
            e.target.blur();
        }
    });
    
    multiplierInput.addEventListener('input', (e) => {
        // –ó–∞–ø—Ä–µ—â–∞–µ–º —É–¥–∞–ª—è—Ç—å 'x' –≤ –Ω–∞—á–∞–ª–µ
        const text = e.target.textContent;
        if (!text.startsWith('x') && !e.target.matches(':focus')) {
            e.target.textContent = 'x' + text.replace(/[^0-9.]/g, '');
        }
    });
}

